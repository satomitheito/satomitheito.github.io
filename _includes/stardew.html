<div class="user-details">
    <img src="/assets/img/myfarm.png" alt="My Farm" class="featured-image" />
</div>
<!-- Sprite Movement Section -->
<div class="sprite-section">
    <div class="canvas-container">
        <canvas id="gameCanvas" width="1000" height="700"></canvas>
    </div>
</div>

<style>
    .canvas-container {
        display: flex;
        justify-content: center; /* Center horizontally */
        align-items: center; /* Center vertically */
        margin: 20px 0; /* Optional spacing around the canvas */
    }

    canvas {
        border: 2px solid black; /* Optional: Add a border */
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3); /* Optional: Add a shadow */
    }

    .user-details {
        text-align: center; /* Center the image in the user-details section */
        margin-bottom: 20px; /* Optional spacing below the image */
    }

    .user-details img {
        max-width: 100%; /* Ensure the image scales appropriately */
        height: auto; /* Maintain aspect ratio */
    }
</style>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // Load the background image
    const background = new Image();
    background.src = "/assets/img/stardewmap.png";
    // Load the sprite
    const sprite = new Image();
    sprite.src = "/assets/img/White Cow.png"; // Adjust path to your sprite image

    // Define sprite and map properties
    const frameWidth = 32; // Width of one frame
    const frameHeight = 32; // Height of one frame
    const scale = 1.9; // Scaling factor for the sprite
    const scaledFrameWidth = frameWidth * scale;
    const scaledFrameHeight = frameHeight * scale;

    const mapWidth = 5216; // Replace with actual map width
    const mapHeight = 4992; // Replace with actual map height
    const zoom = 1.5; // Zoom level for the camera

    // Character object
    const character = {
        x: 2200, // Start in the center of the map
        y: 594,
        speed: 5,
        direction: 0, // Default direction is "Down" (row 0)
    };

    // Camera object
    const camera = {
        x: 0,
        y: 0,
        width: canvas.width / zoom,
        height: canvas.height / zoom,
        update() {
            // Center the camera on the character
            this.x = Math.max(0, Math.min(mapWidth - this.width, character.x - this.width / 2));
            this.y = Math.max(0, Math.min(mapHeight - this.height, character.y - this.height / 2));
        },
    };

    // Keys object for tracking pressed keys
    const keys = {};
    window.addEventListener("keydown", (e) => (keys[e.key] = true));
    window.addEventListener("keyup", (e) => (keys[e.key] = false));

    // Disable scrolling with arrow keys
    window.addEventListener(
        "keydown",
        function (e) {
            if (["Space", "ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].indexOf(e.code) > -1) {
                e.preventDefault();
            }
        },
        false
    );

    // Mapping directions to the correct row in the sprite sheet
    const directionMapping = {
        ArrowDown: 0, // Down corresponds to row 0
        ArrowLeft: 3, // Left corresponds to row 1
        ArrowRight: 1, // Right corresponds to row 2
        ArrowUp: 2, // Up corresponds to row 3
    };

    // Update character movement
    function update() {
        if (keys["ArrowUp"]) {
            character.y -= character.speed;
            character.direction = directionMapping["ArrowUp"];
        }
        if (keys["ArrowDown"]) {
            character.y += character.speed;
            character.direction = directionMapping["ArrowDown"];
        }
        if (keys["ArrowLeft"]) {
            character.x -= character.speed;
            character.direction = directionMapping["ArrowLeft"];
        }
        if (keys["ArrowRight"]) {
            character.x += character.speed;
            character.direction = directionMapping["ArrowRight"];
        }

        // Boundary checks for character within the map
        if (character.x < 0) character.x = 0;
        if (character.y < 0) character.y = 0;
        if (character.x + scaledFrameWidth > mapWidth) character.x = mapWidth - scaledFrameWidth;
        if (character.y + scaledFrameHeight > mapHeight) character.y = mapHeight - scaledFrameHeight;

        // Update camera position
        camera.update();

        // Update animation frame
        frameCounter++;
        if (frameCounter >= frameDelay) {
            frameCounter = 0;
            currentFrame = (currentFrame + 1) % 4; // Assuming 4 frames per direction
        }
    }

    function draw() {
        // Clear the canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Apply zoom
        ctx.save();
        ctx.scale(zoom, zoom);

        // Draw the visible portion of the map
        ctx.drawImage(
            background,
            camera.x,
            camera.y,
            camera.width,
            camera.height,
            0,
            0,
            camera.width,
            camera.height
        );

        // Calculate the source position on the sprite sheet
        const sourceX = currentFrame * frameWidth;
        if (character.direction == 3) {
            const sourceY = 1 * frameHeight;
            ctx.scale(-1,1)
        } else {
            const sourceY = character.direction * frameHeight;
        }

        // Draw the character
        ctx.drawImage(
            sprite,
            sourceX,
            sourceY,
            frameWidth,
            frameHeight,
            (character.x - camera.x) / zoom,
            (character.y - camera.y) / zoom,
            scaledFrameWidth,
            scaledFrameHeight
        );

        // Restore the canvas
        ctx.restore();
    }

    // Game loop
    let frameDelay = 10; // Frames to wait before moving to the next animation frame
    let frameCounter = 0;
    let currentFrame = 0;

    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    // Start the game loop when the images load
    let imagesLoaded = 0;
    function checkImagesLoaded() {
        imagesLoaded++;
        if (imagesLoaded === 2) gameLoop();
    }
    sprite.onload = checkImagesLoaded;
    background.onload = checkImagesLoaded;
</script>